<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مخزن الحسابات | @aboarenx</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-nav { color: #2563eb; background-color: #eff6ff; border-radius: 1rem; }
        input, button, select, textarea { outline: none !important; }
        /* تحسين استجابة اللمس */
        .touch-button { transition: transform 0.1s active; }
        .touch-button:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app">
        <!-- Auth Screen -->
        <div id="auth-screen" class="min-h-screen flex items-center justify-center p-6">
            <div class="w-full max-w-sm">
                <div class="text-center mb-8">
                    <div class="inline-flex p-4 bg-blue-600 text-white rounded-3xl shadow-xl mb-4">
                        <i data-lucide="lock" class="w-10 h-10"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-800">مخزن الموردين</h1>
                    <p id="auth-subtitle" class="text-slate-500 mt-2">سجل دخولك للبدء</p>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100">
                    <form id="auth-form" class="space-y-4">
                        <div id="reg-fields" class="hidden space-y-4">
                            <input type="text" id="reg-name" placeholder="الاسم الكامل" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <input type="text" id="username" placeholder="اسم المستخدم" required class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition text-left">
                        <input type="password" id="password" placeholder="كلمة المرور" required class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition text-left">
                        <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold text-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95">دخول</button>
                    </form>
                </div>
                <button id="toggle-auth" class="w-full mt-6 py-2 text-blue-600 font-bold flex items-center justify-center gap-2">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                    <span id="toggle-text">إنشاء حساب جديد</span>
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <header class="bg-white px-6 py-4 flex justify-between items-center border-b sticky top-0 z-50 shadow-sm">
                <!-- تم إصلاح زر تسجيل الخروج هنا عبر إضافة onclick مباشرة -->
                <button onclick="logoutNow()" class="p-2 text-red-500 bg-red-50 rounded-xl active:scale-90 transition flex items-center justify-center">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </button>
                <div class="text-center">
                    <span id="user-display-name" class="font-black text-slate-800 block">المستخدم</span>
                    <span id="user-role-badge" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold text-slate-500">مورد</span>
                </div>
                <div id="balance-badge" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-black border border-green-200">
                    $0.00
                </div>
            </header>

            <main id="view-container" class="p-4 max-w-lg mx-auto pb-24">
                <!-- المحتوى يتم حقنه هنا -->
            </main>

            <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t px-8 py-3 flex justify-around items-center z-40 shadow-lg">
                <button onclick="changeView('home')" class="nav-item p-3 rounded-2xl transition" data-view="home">
                    <i data-lucide="layout-grid"></i>
                </button>
                <button onclick="changeView('history')" class="nav-item p-3 rounded-2xl text-slate-400 transition" data-view="history">
                    <i data-lucide="history"></i>
                </button>
                <button id="admin-only-btn" onclick="changeView('admin')" class="nav-item p-3 rounded-2xl text-slate-400 transition hidden" data-view="admin">
                    <i data-lucide="settings"></i>
                </button>
            </nav>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl text-sm font-bold opacity-0 transition-all z-[100] pointer-events-none shadow-2xl border border-slate-700"></div>

    <script>
        // --- إدارة الحالة ---
        let state = {
            user: null,
            vendors: JSON.parse(localStorage.getItem('v_db')) || [{id:'admin', username:'admin', password:'admin', name:'المدير', balance: 9999, role:'admin'}],
            inventory: JSON.parse(localStorage.getItem('i_db')) || [],
            logs: JSON.parse(localStorage.getItem('l_db')) || []
        };

        const save = () => {
            localStorage.setItem('v_db', JSON.stringify(state.vendors));
            localStorage.setItem('i_db', JSON.stringify(state.inventory));
            localStorage.setItem('l_db', JSON.stringify(state.logs));
        };

        const notify = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            t.classList.add('opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 3000);
        };

        // --- وظيفة تسجيل الخروج (مصلحة) ---
        window.logoutNow = function() {
            if(confirm("هل تريد تسجيل الخروج؟")) {
                state.user = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                // تصفير مدخلات تسجيل الدخول
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        };

        // --- منطق المصادقة ---
        let isRegMode = false;
        document.getElementById('toggle-auth').onclick = () => {
            isRegMode = !isRegMode;
            document.getElementById('reg-fields').classList.toggle('hidden', !isRegMode);
            document.getElementById('auth-subtitle').innerText = isRegMode ? 'إنشاء حساب مورد جديد' : 'سجل دخولك للبدء';
            document.getElementById('toggle-text').innerText = isRegMode ? 'العودة للدخول' : 'إنشاء حساب جديد';
            document.querySelector('#auth-form button').innerText = isRegMode ? 'تسجيل' : 'دخول';
        };

        document.getElementById('auth-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();

            if (isRegMode) {
                const n = document.getElementById('reg-name').value.trim();
                if(!n) return notify("يرجى كتابة الاسم");
                if(state.vendors.find(v => v.username === u)) return notify("اليوزر مستخدم بالفعل");
                state.vendors.push({id:Date.now(), username:u, password:p, name:n, balance:0, role:'vendor'});
                save();
                notify("تم التسجيل! يمكنك الدخول الآن");
                document.getElementById('toggle-auth').click();
            } else {
                const found = state.vendors.find(v => v.username === u && v.password === p);
                if (found) {
                    state.user = found;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    initDashboard();
                } else {
                    notify("خطأ في اليوزر أو الباسورد");
                }
            }
        };

        // --- لوحة التحكم ---
        function initDashboard() {
            document.getElementById('user-display-name').innerText = state.user.name;
            document.getElementById('user-role-badge').innerText = state.user.role === 'admin' ? 'مدير' : 'مورد';
            document.getElementById('admin-only-btn').classList.toggle('hidden', state.user.role !== 'admin');
            updateBalance();
            changeView('home');
        }

        function updateBalance() {
            document.getElementById('balance-badge').innerText = `$${state.user.balance.toFixed(2)}`;
        }

        function changeView(view) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.toggle('active-nav', el.dataset.view === view);
                el.classList.toggle('text-slate-400', el.dataset.view !== view);
            });

            const container = document.getElementById('view-container');
            if (view === 'home') renderHome(container);
            if (view === 'history') renderHistory(container);
            if (view === 'admin') renderAdmin(container);
            lucide.createIcons();
        }

        function renderHome(container) {
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-slate-800">الحسابات</h2>
                    <a href="https://t.me/aboarenx" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg">
                        <i data-lucide="send" class="w-4 h-4"></i> شحن
                    </a>
                </div>
            `;

            const available = state.inventory.filter(i => i.status === 'available');
            if (available.length === 0) {
                html += `<div class="bg-white p-10 rounded-[2rem] border-2 border-dashed border-slate-200 text-center text-slate-400 font-bold">المخزن فارغ</div>`;
            } else {
                available.forEach(item => {
                    html += `
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl"><i data-lucide="key"></i></div>
                                <div>
                                    <h4 class="font-black text-slate-800">${item.type}</h4>
                                    <p class="text-blue-600 font-black text-sm">$${item.price}</p>
                                </div>
                            </div>
                            <button onclick="handlePurchase('${item.id}')" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-sm touch-button">شراء</button>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        function renderHistory(container) {
            const myLogs = state.user.role === 'admin' ? state.logs : state.logs.filter(l => l.buyerId === state.user.id);
            let html = `<h2 class="text-xl font-black mb-6">مشترياتي</h2>`;
            
            if(myLogs.length === 0) {
                html += `<p class="text-center py-10 text-slate-400">لا توجد عمليات</p>`;
            } else {
                myLogs.forEach(l => {
                    html += `
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-100 mb-4">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2">
                                <span>${l.date}</span>
                                <span class="text-green-600">$${l.price}</span>
                            </div>
                            <h4 class="font-black mb-3">${l.type}</h4>
                            <div class="bg-slate-50 p-4 rounded-2xl text-xs space-y-2 border border-dashed border-slate-200">
                                <p><strong>البيانات:</strong> <span class="text-blue-700 font-mono select-all">${l.details}</span></p>
                                ${l.backup ? `<p><strong>احتياطي:</strong> ${l.backup}</p>` : ''}
                                ${l.notes ? `<p><strong>ملاحظة:</strong> ${l.notes}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        function renderAdmin(container) {
            container.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-black">الإدارة</h2>
                    
                    <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="text-blue-600"></i> إضافة حساب</h3>
                        <div class="space-y-3">
                            <input id="in-type" type="text" placeholder="اسم الخدمة" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <input id="in-details" type="text" placeholder="يوزر:باس" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 text-left">
                            <input id="in-backup" type="text" placeholder="بريد احتياطي" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 text-left">
                            <textarea id="in-notes" placeholder="ملاحظات" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 h-20"></textarea>
                            <input id="in-price" type="number" placeholder="السعر $" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <button onclick="addItem()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold touch-button">إضافة للمخزن</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="wallet" class="text-green-600"></i> شحن رصيد</h3>
                        <div class="space-y-3">
                            <select id="sel-vendor" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                                <option value="">اختر المورد</option>
                                ${state.vendors.filter(v=>v.role!=='admin').map(v=>`<option value="${v.id}">${v.name} ($${v.balance})</option>`)}
                            </select>
                            <input id="in-recharge" type="number" placeholder="المبلغ" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <button onclick="rechargeVendor()" class="w-full bg-green-600 text-white p-4 rounded-2xl font-bold touch-button">تأكيد الشحن</button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- الإجراءات ---
        window.handlePurchase = (id) => {
            const item = state.inventory.find(i => i.id == id);
            if(!item) return;

            if(state.user.balance < item.price) {
                return notify("رصيدك غير كافٍ");
            }

            if(confirm(`هل تريد شراء ${item.type} بـ $${item.price}؟`)) {
                state.user.balance -= item.price;
                item.status = 'sold';
                item.buyerId = state.user.id;

                state.logs.unshift({
                    id: Date.now(),
                    buyerId: state.user.id,
                    type: item.type,
                    price: item.price,
                    details: item.details,
                    backup: item.backup,
                    notes: item.notes,
                    date: new Date().toLocaleString('ar-EG')
                });

                save();
                updateBalance();
                renderHome(document.getElementById('view-container'));
                notify("تم الشراء! راجع سجل المشتريات");
            }
        };

        window.addItem = () => {
            const type = document.getElementById('in-type').value;
            const details = document.getElementById('in-details').value;
            const price = parseFloat(document.getElementById('in-price').value);
            const backup = document.getElementById('in-backup').value;
            const notes = document.getElementById('in-notes').value;

            if(!type || !details || isNaN(price)) return notify("أكمل البيانات");

            state.inventory.push({ id: Date.now(), type, details, price, backup, notes, status: 'available' });
            save();
            notify("تمت الإضافة");
            renderAdmin(document.getElementById('view-container'));
        };

        window.rechargeVendor = () => {
            const vId = document.getElementById('sel-vendor').value;
            const amt = parseFloat(document.getElementById('in-recharge').value);
            if(!vId || isNaN(amt)) return notify("بيانات الشحن ناقصة");

            const vIndex = state.vendors.findIndex(v => v.id == vId);
            state.vendors[vIndex].balance += amt;
            save();
            notify("تم الشحن");
            renderAdmin(document.getElementById('view-container'));
        };

        // تشغيل الأيقونات
        lucide.createIcons();
    </script>
</body>
</html>

