<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مخزن الحسابات | @aboarenx</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-nav { color: #2563eb; background-color: #eff6ff; border-radius: 1rem; }
        .touch-button { transition: transform 0.1s active; }
        .touch-button:active { transform: scale(0.95); }
        .stock-badge { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app">
        <!-- Auth Screen -->
        <div id="auth-screen" class="min-h-screen flex items-center justify-center p-6">
            <div class="w-full max-w-sm">
                <div class="text-center mb-8">
                    <div class="inline-flex p-4 bg-blue-600 text-white rounded-3xl shadow-xl mb-4">
                        <i data-lucide="package-check" class="w-10 h-10"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-800">مخزن الموردين</h1>
                    <p id="auth-subtitle" class="text-slate-500 mt-2">سجل دخولك لإدارة الستوك</p>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100">
                    <form id="auth-form" class="space-y-4">
                        <div id="reg-fields" class="hidden space-y-4">
                            <input type="text" id="reg-name" placeholder="الاسم الكامل" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <input type="text" id="username" placeholder="اسم المستخدم" required class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition text-left">
                        <input type="password" id="password" placeholder="كلمة المرور" required class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-blue-500 transition text-left">
                        <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold text-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95">دخول</button>
                    </form>
                </div>
                <button id="toggle-auth" class="w-full mt-6 py-2 text-blue-600 font-bold flex items-center justify-center gap-2">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                    <span id="toggle-text">إنشاء حساب جديد</span>
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <header class="bg-white px-6 py-4 flex justify-between items-center border-b sticky top-0 z-50 shadow-sm">
                <button onclick="logoutNow()" class="p-2 text-red-500 bg-red-50 rounded-xl active:scale-90 transition flex items-center justify-center">
                    <i data-lucide="log-out" class="w-6 h-6"></i>
                </button>
                <div class="text-center">
                    <span id="user-display-name" class="font-black text-slate-800 block">المستخدم</span>
                    <span id="user-role-badge" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold text-slate-500">مورد</span>
                </div>
                <div id="balance-badge" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-black border border-green-200">
                    $0.00
                </div>
            </header>

            <main id="view-container" class="p-4 max-w-lg mx-auto pb-24">
                <!-- Content Injected Here -->
            </main>

            <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t px-8 py-3 flex justify-around items-center z-40 shadow-lg">
                <button onclick="changeView('home')" class="nav-item p-3 rounded-2xl transition" data-view="home">
                    <i data-lucide="layout-grid"></i>
                </button>
                <button onclick="changeView('history')" class="nav-item p-3 rounded-2xl text-slate-400 transition" data-view="history">
                    <i data-lucide="history"></i>
                </button>
                <button id="admin-only-btn" onclick="changeView('admin')" class="nav-item p-3 rounded-2xl text-slate-400 transition hidden" data-view="admin">
                    <i data-lucide="settings"></i>
                </button>
            </nav>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl text-sm font-bold opacity-0 transition-all z-[100] pointer-events-none shadow-2xl border border-slate-700"></div>

    <script>
        // --- State Management ---
        let state = {
            user: null,
            vendors: JSON.parse(localStorage.getItem('v_db')) || [{id:'admin', username:'admin', password:'admin', name:'المدير', balance: 9999, role:'admin'}],
            // New Category-based Stock System
            categories: JSON.parse(localStorage.getItem('cat_db')) || [],
            logs: JSON.parse(localStorage.getItem('l_db')) || []
        };

        const save = () => {
            localStorage.setItem('v_db', JSON.stringify(state.vendors));
            localStorage.setItem('cat_db', JSON.stringify(state.categories));
            localStorage.setItem('l_db', JSON.stringify(state.logs));
        };

        const notify = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            t.classList.add('opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 3000);
        };

        window.logoutNow = function() {
            if(confirm("هل تريد تسجيل الخروج؟")) {
                state.user = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        };

        // --- Auth ---
        let isRegMode = false;
        document.getElementById('toggle-auth').onclick = () => {
            isRegMode = !isRegMode;
            document.getElementById('reg-fields').classList.toggle('hidden', !isRegMode);
            document.getElementById('auth-subtitle').innerText = isRegMode ? 'إنشاء حساب مورد جديد' : 'سجل دخولك للبدء';
            document.getElementById('toggle-text').innerText = isRegMode ? 'العودة للدخول' : 'إنشاء حساب جديد';
            document.querySelector('#auth-form button').innerText = isRegMode ? 'تسجيل' : 'دخول';
        };

        document.getElementById('auth-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();

            if (isRegMode) {
                const n = document.getElementById('reg-name').value.trim();
                if(!n) return notify("يرجى كتابة الاسم");
                if(state.vendors.find(v => v.username === u)) return notify("اليوزر مستخدم بالفعل");
                state.vendors.push({id:Date.now(), username:u, password:p, name:n, balance:0, role:'vendor'});
                save();
                notify("تم التسجيل!");
                document.getElementById('toggle-auth').click();
            } else {
                const found = state.vendors.find(v => v.username === u && v.password === p);
                if (found) {
                    state.user = found;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    initDashboard();
                } else {
                    notify("خطأ في البيانات");
                }
            }
        };

        // --- Logic ---
        function initDashboard() {
            document.getElementById('user-display-name').innerText = state.user.name;
            document.getElementById('user-role-badge').innerText = state.user.role === 'admin' ? 'مدير' : 'مورد';
            document.getElementById('admin-only-btn').classList.toggle('hidden', state.user.role !== 'admin');
            updateBalance();
            changeView('home');
        }

        function updateBalance() {
            document.getElementById('balance-badge').innerText = `$${state.user.balance.toFixed(2)}`;
        }

        function changeView(view) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.toggle('active-nav', el.dataset.view === view);
                el.classList.toggle('text-slate-400', el.dataset.view !== view);
            });

            const container = document.getElementById('view-container');
            if (view === 'home') renderHome(container);
            if (view === 'history') renderHistory(container);
            if (view === 'admin') renderAdmin(container);
            lucide.createIcons();
        }

        // --- Venders Home ---
        function renderHome(container) {
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-slate-800 tracking-tight">الأصناف المتوفرة</h2>
                    <a href="https://t.me/aboarenx" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg active:scale-95 transition">
                        <i data-lucide="send" class="w-4 h-4"></i> شحن
                    </a>
                </div>
            `;

            if (state.categories.length === 0) {
                html += `<div class="bg-white p-10 rounded-[2rem] border-2 border-dashed border-slate-200 text-center text-slate-400 font-bold">لا توجد أصناف حالياً</div>`;
            } else {
                state.categories.forEach(cat => {
                    const count = cat.items.length;
                    html += `
                        <div class="bg-white p-5 rounded-[2.5rem] border border-slate-100 shadow-sm mb-4 relative overflow-hidden group">
                            <div class="flex items-center justify-between relative z-10">
                                <div class="flex items-center gap-4">
                                    <div class="p-3 bg-blue-50 text-blue-600 rounded-2xl"><i data-lucide="box"></i></div>
                                    <div>
                                        <h4 class="font-black text-slate-800">${cat.name}</h4>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-blue-600 font-black text-sm">$${cat.price}</span>
                                            <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-500 font-bold">متوفر: ${count}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="handlePurchase('${cat.id}')" 
                                        ${count === 0 ? 'disabled' : ''} 
                                        class="bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-sm touch-button ${count === 0 ? 'opacity-30 cursor-not-allowed' : ''}">
                                    ${count === 0 ? 'نفذ' : 'شراء'}
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        // --- Admin Controls ---
        function renderAdmin(container) {
            container.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-black">لوحة الإدارة</h2>
                    
                    <!-- Create Category -->
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="folder-plus" class="text-blue-600"></i> إنشاء صنف جديد</h3>
                        <div class="space-y-3">
                            <input id="cat-name" type="text" placeholder="اسم الصنف (مثلاً ChatGPT سنوي)" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <input id="cat-price" type="number" placeholder="السعر $" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <button onclick="createCategory()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold touch-button">إنشاء الصنف</button>
                        </div>
                    </div>

                    <!-- Add Stock to Category -->
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="text-green-600"></i> إضافة ستوك (حسابات)</h3>
                        <div class="space-y-3">
                            <select id="stock-cat-id" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                                <option value="">اختر الصنف</option>
                                ${state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <input id="stock-details" type="text" placeholder="بيانات الحساب (يوزر:باس)" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 text-left">
                            <input id="stock-backup" type="text" placeholder="بريد احتياطي (اختياري)" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 text-left">
                            <textarea id="stock-notes" placeholder="ملاحظات الحساب" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 h-20"></textarea>
                            <button onclick="addStock()" class="w-full bg-green-600 text-white p-4 rounded-2xl font-bold touch-button">إضافة للحسابات</button>
                        </div>
                    </div>

                    <!-- Recharge -->
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="wallet" class="text-orange-600"></i> شحن رصيد مورد</h3>
                        <div class="space-y-3">
                            <select id="sel-vendor" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                                <option value="">اختر المورد</option>
                                ${state.vendors.filter(v=>v.role!=='admin').map(v=>`<option value="${v.id}">${v.name} ($${v.balance})</option>`)}
                            </select>
                            <input id="in-recharge" type="number" placeholder="المبلغ" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <button onclick="rechargeVendor()" class="w-full bg-orange-600 text-white p-4 rounded-2xl font-bold touch-button">تأكيد الشحن</button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderHistory(container) {
            const myLogs = state.user.role === 'admin' ? state.logs : state.logs.filter(l => l.buyerId === state.user.id);
            let html = `<h2 class="text-xl font-black mb-6">مشترياتي</h2>`;
            
            if(myLogs.length === 0) {
                html += `<p class="text-center py-10 text-slate-400 font-bold">لا توجد عمليات سابقة</p>`;
            } else {
                myLogs.forEach(l => {
                    html += `
                        <div class="bg-white p-5 rounded-[2.5rem] border border-slate-100 mb-4 shadow-sm">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-tighter">
                                <span>${l.date}</span>
                                <span class="text-green-600">$${l.price}</span>
                            </div>
                            <h4 class="font-black mb-3 text-slate-800">${l.type}</h4>
                            <div class="bg-slate-50 p-5 rounded-3xl text-xs space-y-3 border border-dashed border-slate-200">
                                <div><p class="text-slate-400 mb-1">بيانات الحساب:</p><p class="text-blue-700 font-mono select-all font-bold text-sm">${l.details}</p></div>
                                ${l.backup ? `<div><p class="text-slate-400 mb-1">احتياطي:</p><p class="font-bold">${l.backup}</p></div>` : ''}
                                ${l.notes ? `<div><p class="text-slate-400 mb-1">ملاحظة:</p><p class="italic text-slate-600">${l.notes}</p></div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        // --- Actions ---
        window.createCategory = () => {
            const name = document.getElementById('cat-name').value.trim();
            const price = parseFloat(document.getElementById('cat-price').value);
            if(!name || isNaN(price)) return notify("أكمل بيانات الصنف");
            
            state.categories.push({ id: Date.now(), name, price, items: [] });
            save();
            notify("تم إنشاء الصنف");
            renderAdmin(document.getElementById('view-container'));
        };

        window.addStock = () => {
            const catId = document.getElementById('stock-cat-id').value;
            const details = document.getElementById('stock-details').value.trim();
            const backup = document.getElementById('stock-backup').value.trim();
            const notes = document.getElementById('stock-notes').value.trim();

            if(!catId || !details) return notify("أكمل بيانات الحساب");

            const cat = state.categories.find(c => c.id == catId);
            cat.items.push({ id: Date.now(), details, backup, notes });
            save();
            notify(`تمت إضافة الستوك لـ ${cat.name}`);
            renderAdmin(document.getElementById('view-container'));
        };

        window.handlePurchase = (catId) => {
            const cat = state.categories.find(c => c.id == catId);
            if(!cat || cat.items.length === 0) return notify("نفذت الكمية");
            if(state.user.balance < cat.price) return notify("رصيدك غير كافٍ");

            if(confirm(`تأكيد شراء حساب ${cat.name} بـ $${cat.price}؟`)) {
                // Get one item from stock (FIFO)
                const soldItem = cat.items.shift();
                
                state.user.balance -= cat.price;
                
                state.logs.unshift({
                    id: Date.now(),
                    buyerId: state.user.id,
                    type: cat.name,
                    price: cat.price,
                    details: soldItem.details,
                    backup: soldItem.backup,
                    notes: soldItem.notes,
                    date: new Date().toLocaleString('ar-EG')
                });

                save();
                updateBalance();
                renderHome(document.getElementById('view-container'));
                notify("تم الشراء بنجاح!");
            }
        };

        window.rechargeVendor = () => {
            const vId = document.getElementById('sel-vendor').value;
            const amt = parseFloat(document.getElementById('in-recharge').value);
            if(!vId || isNaN(amt)) return notify("بيانات ناقصة");

            const vIndex = state.vendors.findIndex(v => v.id == vId);
            state.vendors[vIndex].balance += amt;
            save();
            notify("تم الشحن");
            renderAdmin(document.getElementById('view-container'));
        };

        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>

