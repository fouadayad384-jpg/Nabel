<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مخزن الحسابات السحابي | @aboarenx</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aboarenx-store';

        // --- State ---
        let currentUserData = null;
        let categories = [];
        let logs = [];

        // --- UI Elements ---
        const authScreen = document.getElementById('auth-screen');
        const dashboard = document.getElementById('dashboard');
        const viewContainer = document.getElementById('view-container');
        const toast = document.getElementById('toast');

        const notify = (msg) => {
            toast.innerText = msg;
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
        };

        // --- Auth Persistence ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    currentUserData.uid = user.uid;
                    showDashboard();
                } else {
                    // This handles cases where auth exists but no firestore doc (e.g. manual delete)
                    auth.signOut();
                }
            } else {
                showAuth();
            }
        });

        // --- Real-time Listeners ---
        function initDataListeners() {
            // Listen for Categories
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'categories'), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (dashboard.style.display !== 'none') renderCurrentView();
            });

            // Listen for My Logs
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'logs'), (snapshot) => {
                const allLogs = snapshot.docs.map(doc => doc.data());
                logs = currentUserData.role === 'admin' 
                    ? allLogs 
                    : allLogs.filter(l => l.buyerId === currentUserData.uid);
                if (dashboard.style.display !== 'none') renderCurrentView();
            });

            // Listen for My Balance
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'users', auth.currentUser.uid), (doc) => {
                if (doc.exists()) {
                    currentUserData.balance = doc.data().balance;
                    document.getElementById('balance-badge').innerText = `$${currentUserData.balance.toFixed(2)}`;
                }
            });
        }

        function showAuth() {
            authScreen.style.display = 'flex';
            dashboard.style.display = 'none';
        }

        function showDashboard() {
            authScreen.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('user-display-name').innerText = currentUserData.name;
            document.getElementById('user-role-badge').innerText = currentUserData.role === 'admin' ? 'مدير' : 'مورد';
            document.getElementById('admin-only-btn').classList.toggle('hidden', currentUserData.role !== 'admin');
            initDataListeners();
            window.changeView('home');
        }

        // --- Functions Exposed to Window ---
        window.handleAuth = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const isReg = document.getElementById('reg-fields').classList.contains('hidden') === false;

            try {
                // For simplicity in this demo, we use anonymous auth linked to a username in Firestore
                // In a real production app, you'd use email/pass auth.
                const cred = await signInAnonymously(auth);
                const uid = cred.user.uid;

                if (isReg) {
                    const name = document.getElementById('reg-name').value.trim();
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'users', uid), {
                        username: u, password: p, name, balance: 0, role: 'vendor'
                    });
                    notify("تم التسجيل بنجاح");
                } else {
                    // Check if credentials match (Demo logic)
                    const userRef = doc(db, 'artifacts', appId, 'public', 'users', uid);
                    // Since it's anonymous, we check if the doc exists and matches
                    // Note: This logic is simplified for the prompt's scope
                }
            } catch (err) {
                notify("حدث خطأ في النظام");
            }
        };

        window.logoutNow = () => {
            if(confirm("هل تريد تسجيل الخروج؟")) auth.signOut();
        };

        let currentActiveView = 'home';
        window.changeView = (view) => {
            currentActiveView = view;
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.toggle('active-nav', el.dataset.view === view);
                el.classList.toggle('text-slate-400', el.dataset.view !== view);
            });
            renderCurrentView();
        };

        function renderCurrentView() {
            if (currentActiveView === 'home') renderHome();
            if (currentActiveView === 'history') renderHistory();
            if (currentActiveView === 'admin') renderAdmin();
            lucide.createIcons();
        }

        function renderHome() {
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-slate-800">الأصناف</h2>
                    <a href="https://t.me/aboarenx" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold">شحن</a>
                </div>
            `;
            categories.forEach(cat => {
                const count = cat.items ? cat.items.length : 0;
                html += `
                    <div class="bg-white p-5 rounded-[2rem] border mb-4 flex items-center justify-between">
                        <div>
                            <h4 class="font-black text-slate-800">${cat.name}</h4>
                            <div class="flex gap-2 text-sm font-bold">
                                <span class="text-blue-600">$${cat.price}</span>
                                <span class="text-slate-400">الستوك: ${count}</span>
                            </div>
                        </div>
                        <button onclick="window.purchaseItem('${cat.id}')" ${count === 0 ? 'disabled' : ''} class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm ${count === 0 ? 'opacity-30' : ''}">
                            ${count === 0 ? 'نفذ' : 'شراء'}
                        </button>
                    </div>
                `;
            });
            viewContainer.innerHTML = html;
        }

        function renderHistory() {
            let html = `<h2 class="text-xl font-black mb-6 text-slate-800">مشترياتي</h2>`;
            const sortedLogs = logs.sort((a,b) => b.timestamp - a.timestamp);
            if(sortedLogs.length === 0) html += `<p class="text-center py-10 text-slate-400">لا يوجد سجلات</p>`;
            sortedLogs.forEach(l => {
                html += `
                    <div class="bg-white p-5 rounded-[2rem] border mb-4 shadow-sm">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase">
                            <span>${new Date(l.timestamp).toLocaleString('ar-EG')}</span>
                            <span class="text-green-600">$${l.price}</span>
                        </div>
                        <h4 class="font-black mb-2">${l.categoryName}</h4>
                        <div class="bg-slate-50 p-4 rounded-2xl text-xs font-mono break-all border border-dashed select-all">
                            ${l.details}
                        </div>
                    </div>
                `;
            });
            viewContainer.innerHTML = html;
        }

        function renderAdmin() {
            let html = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-black">الإدارة السحابية</h2>
                    
                    <div class="bg-white p-6 rounded-[2rem] border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="folder-plus"></i> صنف جديد</h3>
                        <div class="space-y-3">
                            <input id="new-cat-name" type="text" placeholder="اسم الصنف" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <input id="new-cat-price" type="number" placeholder="السعر $" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                            <button onclick="window.createNewCategory()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold">إنشاء</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-[2rem] border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="edit"></i> تعديل الأسعار</h3>
                        <div class="space-y-3">
                            ${categories.map(cat => `
                                <div class="flex items-center gap-2">
                                    <span class="flex-1 font-bold text-sm">${cat.name}</span>
                                    <input id="edit-price-${cat.id}" type="number" value="${cat.price}" class="w-20 p-2 bg-slate-50 rounded-xl text-center font-bold">
                                    <button onclick="window.updatePrice('${cat.id}')" class="bg-blue-600 text-white p-2 rounded-xl"><i data-lucide="save" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-[2rem] border">
                        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle"></i> إضافة ستوك</h3>
                        <div class="space-y-3">
                            <select id="stock-select-cat" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100">
                                ${categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <textarea id="stock-data" placeholder="يوزر:باس أو الكود" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 h-20"></textarea>
                            <button onclick="window.addCategoryStock()" class="w-full bg-green-600 text-white p-4 rounded-2xl font-bold">إضافة للستوك</button>
                        </div>
                    </div>
                </div>
            `;
            viewContainer.innerHTML = html;
        }

        // --- Logic Handlers ---
        window.createNewCategory = async () => {
            const name = document.getElementById('new-cat-name').value;
            const price = parseFloat(document.getElementById('new-cat-price').value);
            if(!name || isNaN(price)) return notify("أكمل البيانات");
            await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'categories')), { name, price, items: [] });
            notify("تم الإنشاء");
        };

        window.updatePrice = async (id) => {
            const newPrice = parseFloat(document.getElementById(`edit-price-${id}`).value);
            if(isNaN(newPrice)) return notify("السعر غير صحيح");
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'categories', id), { price: newPrice });
            notify("تم تحديث السعر");
        };

        window.addCategoryStock = async () => {
            const id = document.getElementById('stock-select-cat').value;
            const data = document.getElementById('stock-data').value;
            if(!id || !data) return notify("أدخل البيانات");
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'categories', id), {
                items: arrayUnion(data)
            });
            notify("تمت إضافة الستوك");
        };

        window.purchaseItem = async (catId) => {
            const cat = categories.find(c => c.id === catId);
            if(!cat || !cat.items.length) return notify("نفذت الكمية");
            if(currentUserData.balance < cat.price) return notify("رصيدك غير كافٍ");

            if(confirm(`تأكيد شراء ${cat.name}؟`)) {
                const soldItem = cat.items[0];
                const userRef = doc(db, 'artifacts', appId, 'public', 'users', auth.currentUser.uid);
                const catRef = doc(db, 'artifacts', appId, 'public', 'categories', catId);
                const logRef = doc(collection(db, 'artifacts', appId, 'public', 'logs'));

                // Transaction-like update (simplified)
                await updateDoc(userRef, { balance: currentUserData.balance - cat.price });
                await updateDoc(catRef, { items: arrayRemove(soldItem) });
                await setDoc(logRef, {
                    buyerId: auth.currentUser.uid,
                    categoryName: cat.name,
                    price: cat.price,
                    details: soldItem,
                    timestamp: Date.now()
                });
                notify("تم الشراء بنجاح!");
            }
        };

        // --- UI Events ---
        document.getElementById('toggle-auth').onclick = () => {
            const reg = document.getElementById('reg-fields');
            reg.classList.toggle('hidden');
            document.getElementById('toggle-text').innerText = reg.classList.contains('hidden') ? 'إنشاء حساب جديد' : 'العودة للدخول';
        };

        document.getElementById('auth-form').onsubmit = window.handleAuth;

    </script>
    <style>
        body { font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-nav { color: #2563eb; background-color: #eff6ff; border-radius: 1rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app">
        <!-- Auth Screen -->
        <div id="auth-screen" class="min-h-screen flex items-center justify-center p-6 bg-slate-50">
            <div class="w-full max-w-sm">
                <div class="text-center mb-8">
                    <div class="inline-flex p-4 bg-blue-600 text-white rounded-3xl shadow-xl mb-4">
                        <i data-lucide="cloud-lightning" class="w-10 h-10"></i>
                    </div>
                    <h1 class="text-3xl font-black text-slate-800 tracking-tight">مخزن السحاب</h1>
                    <p class="text-slate-500 mt-2">نظام @aboarenx السحابي</p>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100">
                    <form id="auth-form" class="space-y-4">
                        <div id="reg-fields" class="hidden space-y-4">
                            <input type="text" id="reg-name" placeholder="الاسم الكامل" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                        </div>
                        <input type="text" id="username" placeholder="اسم المستخدم" required class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 text-left">
                        <input type="password" id="password" placeholder="كلمة المرور" required class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 text-left">
                        <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold text-lg active:scale-95 transition shadow-lg">دخول النظام</button>
                    </form>
                </div>
                <button id="toggle-auth" class="w-full mt-6 py-2 text-blue-600 font-bold text-sm">
                    <span id="toggle-text">إنشاء حساب جديد</span>
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <header class="bg-white px-6 py-4 flex justify-between items-center border-b sticky top-0 z-50">
                <button onclick="logoutNow()" class="p-2 text-red-500 bg-red-50 rounded-xl"><i data-lucide="log-out"></i></button>
                <div class="text-center">
                    <span id="user-display-name" class="font-black text-slate-800 block"></span>
                    <span id="user-role-badge" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold text-slate-500 uppercase"></span>
                </div>
                <div id="balance-badge" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-black border border-green-200">$0.00</div>
            </header>

            <main id="view-container" class="p-4 max-w-lg mx-auto pb-24"></main>

            <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t px-8 py-3 flex justify-around items-center z-40">
                <button onclick="changeView('home')" class="nav-item p-3 rounded-2xl transition" data-view="home"><i data-lucide="layout-grid"></i></button>
                <button onclick="changeView('history')" class="nav-item p-3 rounded-2xl text-slate-400 transition" data-view="history"><i data-lucide="history"></i></button>
                <button id="admin-only-btn" onclick="changeView('admin')" class="nav-item p-3 rounded-2xl text-slate-400 transition hidden" data-view="admin"><i data-lucide="settings"></i></button>
            </nav>
        </div>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl text-sm font-bold opacity-0 transition-all z-[100] pointer-events-none shadow-2xl"></div>

    <script>lucide.createIcons();</script>
</body>
</html>

